### 输出比较初始化



以下内容为ai生成

---

STM32F4 的输出比较模块是通过比较 TIMx_CCRx 寄存器中的值和 TIMx_CNT 寄存器中的值来实现比较的。具体的执行过程如下：

- 1.设置输出比较模块的输入时钟和计数模式。
  - 通过设置 TIMx_PSC 和 TIMx_ARR 寄存器，设置输入时钟分频比和计数模式。
- 2.设置输出比较模块的输出模式和互补输出模式。
  - 通过设置 TIMx_CCMRx 寄存器，设置输出模式和互补输出模式，包括比较模式、极性、预装载等。
- 3.设置输出比较模块的比较值。
  - 通过设置 TIMx_CCRx 寄存器，设置比较值，即要比较的值。
- 4.启动计数器。
  - 通过设置 TIMx_CR1 寄存器中的计数器使能位 CEN，启动计数器。
- 5.比较操作。
  - 当 TIMx_CNT 寄存器的计数值到达 TIMx_CCRx 寄存器的值时，输出比较模块会产生一个比较事件，并根据设置的输出模式进行相应的输出操作.输出操作包括输出使能、极性控制、输出占空比或者保持输出等。
- 6.循环执行比较操作。
  - 比较操作会在计数器计数到 TIMx_ARR 寄存器值时自动重复执行，直到禁止计数器。

---

以上内容由ai生成



####初始化定时器输出比较需要用到

在库函数中需要用到

```C
typedef struct
{
  uint16_t TIM_OCMode;          //输出比较模式选择
  uint16_t TIM_OutputState;     //输出比较使能
  uint16_t TIM_OutputNState;    //互补输出比较使能
  uint32_t TIM_Pulse;           //捕获/比较寄存器值，即比较值
  uint16_t TIM_OCPolarity;      //输出比较极性
  uint16_t TIM_OCNPolarity;     //互补输出极性
  uint16_t TIM_OCIdleState;     //输出空闲状态
  uint16_t TIM_OCNIdleState;    //互补输出空闲状态
} TIM_OCInitTypeDef;
```

在寄存器工程中中需要用到以下寄存器：

- CCMR1/CCMR2(捕获比较模式寄存器1/捕获比较模式寄存器2)

  - 输出比较模式选择

    - CCMR1 位 6:4 OC1M：输出比较 1 模式

    - CCMR1 位 14:12 OC2M：输出比较 2 模式

    - CCMR2 位 6:4 OC3M：输出比较 3 模式

    - CCMR2 位 14:12 OC4M：输出比较 4 模式

    - 6种模式

      - ==000==：输出比较对输出没有任何影响

      - ==001==：计数器 TIMx_CNT = CCRx 时，OCxREF 输出有效电平，即强制输出高电平。

      - ==010==：计数器 TIMx_CNT = CCRx 时，OCxREF 输出无效电平，即强制输出低电平。

      - ==011==：计数器 TIMx_CNT = CCRx 时，OCxREF 发生翻转。

      - ==110==：PWM 模式 1

        - 在递增计数模式下，只要 TIMx_CNT < CCRx，通道 x 便为有效状态(OC1REF=“1”)，否则为无效状态(OC1REF=“0”)。
        - 在递减计数模式下，只要 TIMx_CNT > CCRx，通道 x 便为无效状态(OC1REF=“0”)，否则为有效状态(OC1REF=“1”)。
        - 即在PWN 模式 1下，不论是递增计数模式、递减计数模式，只有当TIMx_CNT < CCRx时，通道 x 才输出高电平。否则输出低电平。

      - ==111==：PWM 模式 2

        - 在递增计数模式下，只要 TIMx_CNT < CCRx，通道 x 便为无效状态(OC1REF=“0”)，否则为有效状态(OC1REF=“1”)。

        - 在递减计数模式下，只要 TIMx_CNT > CCRx，通道 x 便为有效状态(OC1REF=“1”)，否则为无效状态(OC1REF=“0”)。

        - 即在PWN 模式 2下，不论是递增计数模式、递减计数模式，只有当TIMx_CNT > CCRx时，通道 x 才输出高电平。否则输出低电平。

        - ```c
          //如果是通道1、通道3，可以直接借鉴，如果是通道2、通道4，需要在原来的基础上 << 8位
          //因为捕获比较模式寄存器是 8位 控制一个通道
          #define TIM_OCMode_Timing                  ((uint16_t)0x0000)
          #define TIM_OCMode_Active                  ((uint16_t)0x0010)
          #define TIM_OCMode_Inactive                ((uint16_t)0x0020)
          #define TIM_OCMode_Toggle                  ((uint16_t)0x0030)
          #define TIM_OCMode_PWM1                    ((uint16_t)0x0060)
          #define TIM_OCMode_PWM2                    ((uint16_t)0x0070)

- CCER(捕获/比较使能寄存器)

  - 位[0:3] 通道1(有互补)	位[4:7] 通道2(有互补)	位[8:11] 通道3(有互补)	位[12:13] 通道4(无互补)
    - 输出比较使能
      - 位 0/4/8/12
      - 0：关闭
      - 1：开启

    - 输出比较极性
      - 位 1/5/9/13
      - 0：OCx 高电平有效
      - 1：OCx 低电平有效

    - 互补输出比较使能
      - 位 2/6/10
      - 0：关闭
      - 1：开启

    - 互补输出极性
      - 位 3/7/11
      - 0：OCxN 高电平有效
      - 1：OCxN 低电平有效

- CR2(控制寄存器2)

  - 位[8:9] 通道1(有互补)	位[10:11] 通道2(有互补)	位[12:13] 通道3(有互补)	位[14] 通道4(无互补)
    - 输出空闲状态
      - 位 8/10/12/14
      - 0：当 MOE=0 时，（如果 OC1N 有效，则经过死区时间之后）OC1=0
      - 1：当 MOE=0 时，（如果 OC1N 有效，则经过死区时间之后）OC1=1

    - 互补输出空闲状态
      - 位 9/11/13
      - 0：当 MOE=0 时，经过死区时间后 OC1N=0
      - 1：当 MOE=0 时，经过死区时间后 OC1N=1

- CCR1/CCR2/CCR3/CCR4(捕获/比较寄存器)

  - 设置捕获/比较寄存器值，即比较值
    - CCRx 是捕获/比较寄存器 x 的预装载值
    - 0~65535
    - 初始化一般设置为0


```C
//TIM1输出比较初始化

//CCMR1:输出比较模式选择
//6种模式:000、001、010、011、110、111
//设置为110，即PWM1模式
TIM1->CCMR1 |= (TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1);

//CCER:输出比较使能、输出比较极性、互补输出比较使能、互补输出极性
//0:不使能		1:使能
//0:极性为低	1:极性为高
//0:不使能		1:使能
//0:极性为低	1:极性为高
//TIM1_CH1有效电平为高，不使用互补输出
TIM1->CCER |= (TIM_CCER_CC1E | TIM_CCER_CC1P);

//CR2:输出空闲状态、互补输出空闲状态
//设置为0，也可不设置，默认为0
TIM1->CR2 |= 0x00;

//CCRx预装载值
//TIM1_CH1预装载值设置为0
TIM1->CCR1 |= 0x00;
```



---



### 输入捕获初始化

> 要在输入捕获模式下使用计时器，必须执行以下步骤:
>
> 
>
> 启用TIM时钟
>
> 
>
> 通过配置相应的GPIO引脚来配置TIM引脚
>
> 
>
> 按照此驱动程序的第一部分中所述配置时间基础单元，
>
> 如果需要，否则计时器将使用默认配置运行:
>
>   自动加载值 = 0xFFFF
>
>   预分频器值 = 0x0000
>
>   计数器模式 = 向上计数
>
>   时钟划分 = TIM_CKD_DIV1
>
> 
>
> 用所需的参数填充初始化输入捕获:
>
> TIM通道: TIM_Channel
>
> TIM输入捕获极性: TIM_ICPolarity
>
> TIM输入捕获选择: TIM_ICSelection
>
> TIM输入捕获预分频器: TIM_ICPrescaler
>
> TIM输入捕获过滤器值: TIM_ICFilter
>
> 
>
> 使NVIC或DMA能够读取测量的频率。
>
> 
>
> 启用相应的中断 (或DMA请求) 以读取捕获的值
>
> 
>
> 调用TIM_Cmd(ENABLE) 函数来启用TIM计数器。
>
> 
>
> 使用TIM_GetCapturex(TIMx); 读取捕获的值。

#### 初始化输入捕获需要用到

在库函数中需要用到

```c
typedef struct
{
  uint16_t TIM_Channel;     //输入捕获通道
  uint16_t TIM_ICPolarity;  //捕获极性，边沿触发方式
  uint16_t TIM_ICSelection; //映射关系
  uint16_t TIM_ICPrescaler; //分频系数
  uint16_t TIM_ICFilter;    //滤波器
} TIM_ICInitTypeDef;
```

在寄存器工程中中需要用到以下寄存器：

- CCMR1/CCMR2(捕获比较模式寄存器1/捕获比较模式寄存器2)
  - 映射关系
    - CCMR1 位 1:0 CC1S：捕获/比较 1 选择
    - CCMR1 位 9:8 CC2S：捕获/比较 2 选择
    - CCMR2 位 1:0 CC3S：捕获/比较 3 选择
    - CCMR2 位 9:8 CC4S：捕获/比较 4 选择
      - 四种模式
      - 00：CCx 通道配置为输出
      - 01：CCx 通道配置为输入，ICx 映射到 TIx 上
      - 10：CCx 通道配置为输入，IC1 映射到 TI2 上/IC2 映射到 TI1 上/IC3 映射到 TI4 上/IC4 映射到 TI3 上
      - 11：CCx 通道配置为输入，ICx 映射到 TRC 上。
  - 分频系数
    - 位 3:2 IC1PSC：输入捕获 1 预分频器
    - 位 11:10 IC2PSC：输入捕获 2 预分频器
    - 位 3:2 IC3PSC：输入捕获 3 预分频器
    - 位 11:10 IC4PSC：输入捕获 4 预分频器
      - 只要 CCxE=“0”（TIMx_CCER 寄存器），预分频器便立即复位。
      - 00：无预分频器，捕获输入上每检测到一个边沿便执行捕获
      - 01：每发生 2 个事件便执行一次捕获
      - 10：每发生 4 个事件便执行一次捕获
      - 11：每发生 8 个事件便执行一次捕获
  - 滤波器
    - 位 7:4 IC1F：输入捕获 1 滤波器
    - 位 15:12 IC2F：输入捕获 2 滤波器
    - 位 7:4 IC3F：输入捕获 3 滤波器
    - 位 15:12 IC4F：输入捕获 4 滤波器
      - 此位域可定义 TIx 输入的采样频率和适用于 TIx 的数字滤波器带宽。数字滤波器由事件计数器组成，  每 N 个事件才视为一个有效边沿：
        - 0000：无滤波器，按 fDTS 频率进行采样
        - 0001：fSAMPLING=fCK_INT，N=2
        - 0010：fSAMPLING=fCK_INT，N=4
        - 0011：fSAMPLING=fCK_INT，N=8
        - 0100：fSAMPLING=fDTS/2，N=6
        - 0101：fSAMPLING=fDTS/2，N=8
        - 0110：fSAMPLING=fDTS/4，N=6
        - 0111：fSAMPLING=fDTS/4，N=8
        - 1000：fSAMPLING=fDTS/8，N=6
        - 1001：fSAMPLING=fDTS/8，N=8
        - 1010：fSAMPLING=fDTS/16，N=5
        - 1011：fSAMPLING=fDTS/16，N=6
        - 1100：fSAMPLING=fDTS/16，N=8
        - 1101：fSAMPLING=fDTS/32，N=5
        - 1110：fSAMPLING=fDTS/32，N=6
        - 1111：fSAMPLING=fDTS/32，N=8
- CCER(捕获/比较使能寄存器)
  - 捕获极性，边沿触发方式
    - 输入捕获使能
      - 位 0/4/8/12
      - 0：关闭
      - 1：开启
    - 输入捕获边沿触发方式
      - 位 [1,3]/[5,7]/[9.11]/13
      - CCxNP/CCxP位可针对触发或捕获操作选择 TIxFP1 和 TIxFP1 的有效极性。
      - 00：非反相/上升沿触发
      - 01：反相/下降沿触发
      - 10：保留，不使用此配置。
      - 11：未反相/边沿触发。电路对 TIxFP1 上升沿和下降沿都敏感，TIxFP1 未反相。编码器模式下不得使用此配置。

```C
//TIM2_CH1输入捕获初始化
//IC1映射到TI1、不分频、不滤波
TIM2->CCMR1 |= (TIM_CCMR1_CC1S_0 | 0x00 | 0x00);
//使能输入捕获、非反相/上升沿触发( TIM_CCER_CC1P = 0x00,TIM_CCER_CC1NP = 0x00 )
TIM2->CCER  |= (TIM_CCER_CC1E | 0x00 | 0x00);
```



