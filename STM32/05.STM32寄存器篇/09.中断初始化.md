# 关于中断

- **NVIC** 是嵌套向量中断控制器
- CM4 内核支持 256 个中断，其中包含了 16 个内核中断和 240 个外部中断，并且具有256 级的可编程中断设置。
- 但 STM32F4 并没有使用 CM4 内核的全部东西，而是只用了它的一部分。
  - STM32F40xx/STM32F41xx 总共有 92 个中断
  - STM32F42xx/STM32F43xx 则总共有 96 个中断
- STM32F40xx/STM32F41xx 的 92 个中断里面，包括 10 个内核中断和 82 个可屏蔽中断，具有 16 级可编程的中断优先级，而我们常用的就是这 82 个可屏蔽中断。

==下面详细介绍一下最常用的定时器中断和外部中断的初始化==

##定时器中断初始化

由于定时器中断没有中断线需要配置，所以我们只需要直接设置它的中断向量、中断优先级就行。

### 中断向量选择

根据需要查阅资料。

如果需要复制，可以去启动文件`startup_stm32f40_41xxx.s`中的中断向量表中寻找，也可以去`stm32f4xx.h`中寻找。

在启动文件`startup_stm32f40_41xxx.s`中的是中断服务函数的函数名，在`stm32f4xx.h`中的是中断向量和IP[x]的对应

###设置中断优先级

中断优先级涉及到==抢占优先级==、==响应优先级==的配置：

>高**抢占优先级**中断	可以打断	正在进行的低**抢占优先级**的中断
>相同**抢占优先级**，高==响应优先级==	不可打断	==低响应优先级==
>
>**抢占优先级**相同的中断，比较==响应优先级==，哪个高哪个先执行
>
>**抢占优先级**和==响应优先级==都相同，哪个中断先发生就先执行

- 抢占优先级：最高位为 0 
  - 高 > 低，可以打断
  - 相同，比较响应优先级
- 响应优先级：最高位为 0 
  - 高 > 低，不可打断
  - 抢占、响应均相同，中断发生先后顺序，先发生先执行

```c
uint8_t tmppriority = 0x00, tmppre = 0x00, tmpsub = 0x0F;
/* Compute the Corresponding IRQ Priority --------------------------------*/    
tmppriority = (0x700 - ((SCB->AIRCR) & (uint32_t)0x700))>> 0x08;
tmppre = (0x4 - tmppriority);
tmpsub = tmpsub >> tmppriority;

tmppriority = NVIC_InitStruct->NVIC_IRQChannelPreemptionPriority << tmppre;
tmppriority |=  (uint8_t)(NVIC_InitStruct->NVIC_IRQChannelSubPriority & tmpsub);

tmppriority = tmppriority << 0x04;

NVIC->IP[NVIC_InitStruct->NVIC_IRQChannel] = tmppriority;

/* Enable the Selected IRQ Channels --------------------------------------*/
NVIC->ISER[NVIC_InitStruct->NVIC_IRQChannel >> 0x05] =
    (uint32_t)0x01 << (NVIC_InitStruct->NVIC_IRQChannel & (uint8_t)0x1F);
```

- 假设中断优先级分组为0x600 = 110 0000 0000。抢占优先级为 1，响应优先级为 5

- 第一行

  - 读取SCB->AIRCR中的中断优先级分组，与上 0x700 = 111 0000 0000后，得到AIRCR[10,8]的具体内容。110 0000 0000。

  - 用 0x700 = 111 0000 0000减去AIRCR[10,8]后，再左移8位后得到抢占优先级的位数==tmppriority==。==tmppriority== = 111 - 110 = 1。

  - 
    | **组** | AIRCR[10：8] | IP bit[7：4]分配情况 | 分配结果                     |
    | ------ | ------------ | -------------------- | ---------------------------- |
    | **0**  | 111          | 0：4                 | 0位抢占优先级，4位响应优先级 |
    | **1**  | 110          | 1：3                 | 1位抢占优先级，3位响应优先级 |
    | **2**  | 101          | 2：2                 | 2位抢占优先级，2位响应优先级 |
    | **3**  | 100          | 3：1                 | 3位抢占优先级，1位响应优先级 |
    | **4**  | 011          | 4：0                 | 4位抢占优先级，0位响应优先级 |

  - ```
    中断优先级分组SCB->AIRCR
    0x700	111 0000 0000
    0x600	110 0000 0000
    0x500	101 0000 0000
    0x400	100 0000 0000
    0x300	011 0000 0000
    ```

- 第二行
  - 0x4 - 抢占优先级的位数 = 响应优先级的位数**tmppre**。**tmppre** = 4 - 1 = 3。
  
- 第三行

  - 将tmpsub = 0x0F = 0000 1111右移==tmppriority==位，得到抢占优先级和响应优先级在 IP bit[7:4]中的分配情况。tmpsub = 0000 0111。
  - 在`core_cm4.h`的NVIC_Type结构体中我们可以看到`uint8_t  IP[240]`，这刚好对应了CM4 内核支持的 240 个外部中断。
  - 在`uint8_t  IP[240]`中，每一个数组都是 8 位的，其中只有高四位IP bit[7：4]会被用于存放中断优先级。
  - 每一个中断对应的数组标号可以在`stm32f4xx.h`中寻找到。

- 第四行

  - 将抢占优先级`NVIC_InitStruct->NVIC_IRQChannelPreemptionPriority`左移**tmppre**位，即响应优先级的位数，赋值给tmppriority。
  - tmppriority = 1 << 3 = 0000 1000

- 第四行

  - 将响应优先级`NVIC_InitStruct->NVIC_IRQChannelSubPriority`与上tmpsub以检查参数，0000 0101 & 0000 0111 = 0000 0101
  - 最后或给tmppriority。0000 1000 |= 0000 0101得到0000 1101

- 第五、六行

  - tmppriority左移四位，得到抢占优先级和响应优先级在 IP bit[7:4]中的分配情况，IP bit[7:4] = 1101 0000
  - 并赋值给对应的中断

- 第七、八行

  - 使能对应中断，通过操作中断设置使能寄存器`NVIC->ISER`来实现中断的使能；相反如果要清除使能，要用到中断清除使能寄存器`NVIC->ICER`
  - ![image-20230409111254710](assets/image-20230409111254710.png)
  - ![image-20230409111325710](assets/image-20230409111325710.png)
  - 假设我们需要使能中断68 = 0100 0100，左移5位后得到 10 = 2，判断使用 `NVIC->ISER[2]`
  - 将中断 68 = 0100 0100 与上 0001 1111后，判断需要在`NVIC->ISER[2]`的第 0000 0100 = 4 位写入1
  - 清除使能同理


### 定时器中断使能

仅仅在NVIC->ISCR使能是不够的，还必须使能TIM中断寄存器 TIMx_DIER

在STM32F407中，除了 TIM10/11/13/14没有 TIMx_DIER 中断使能寄存器，其他定时器都有中断使能定时器 TIMx_DIER。

在定时器中断的使能中 只需要将其 位 0 UIE：更新中断使能 置 1即可

###编写中断服务函数

编写中断函数最重要的是检查TIM中断是否已发生、清除中断标志位。

#### 检查TIM中断是否已发生

在TIM1 ~ TIM14中，每一个定时器都有 TIMx_SR 状态寄存器，通过读取其 位 0 UIF：更新中断标志，我们可以知道该定时器是否发生中断。

在库函数中，判断一个定时器是否发生中断，需要同时检查该定时器的 中断是否使能、中断更新标志是否置 1

#### 清除中断标志位

清除中断标志位只需要将 TIMx_SR 状态寄存器的 位 0 UIF：更新中断标志 置0 即可

## 外部中断初始化

略







STM32F405xx/07xx 和 STM32F415xx/17xx 的向量表：

![1656248000721](assets/1656248000721.png)

![1656248037166](assets/1656248037166.png)

![1656248067872](assets/1656248067872.png)

![1656248087766](assets/1656248087766.png)
